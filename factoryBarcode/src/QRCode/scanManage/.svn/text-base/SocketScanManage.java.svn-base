/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * scanManage.java
 *
 * Created on 2017-10-9, 10:31:17
 */
package QRCode.scanManage;

import QRCode.base.DataBaseUtil;
import QRCode.base.StringUtils;
import QRCode.base.VoiceUtils;
import QRCode.compnents.MessageUtils;
import QRCode.task.model.BoxConnProd;
import QRCode.task.model.Task;
import java.awt.EventQueue;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import javax.swing.JOptionPane;
import org.apache.log4j.Logger;

/**
 *
 * @author Administrator
 */
public class SocketScanManage extends javax.swing.JPanel {

    static final Logger logger = Logger.getLogger(SocketScanManage.class);
    private LocalSocketServer localSocketServer;
    Task task;

    /** Creates new form scanManage */
    public SocketScanManage() {
        initComponents();
        initData();
    }

    private void initData() {
        comboxTask.setModel(DataBaseUtil.queryTaskForCombo());
        comboxTaskActionPerformed(null);
        breakCarton.setModelWithParam(DataBaseUtil.queryParamByPid("BK_PT"));
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel1 = new javax.swing.JLabel();
        jPanel1 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTextArea1 = new javax.swing.JTextArea();
        jPanel3 = new javax.swing.JPanel();
        jButton4 = new javax.swing.JButton();
        jButton5 = new javax.swing.JButton();
        jButton6 = new javax.swing.JButton();
        jPanel2 = new javax.swing.JPanel();
        comboxTask = new QRCode.compnents.MyCombobox();
        jLabel2 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        breakCarton = new QRCode.compnents.MyCombobox();
        portId = new javax.swing.JTextField();
        jLabel7 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        batchLine = new javax.swing.JTextField();
        jLabel8 = new javax.swing.JLabel();
        standard = new javax.swing.JTextField();

        jLabel1.setText("jLabel1");
        jLabel1.setName("jLabel1"); // NOI18N

        jPanel1.setFocusable(false);
        jPanel1.setName("jPanel1"); // NOI18N

        jScrollPane1.setName("jScrollPane1"); // NOI18N

        jTextArea1.setColumns(20);
        jTextArea1.setFont(new java.awt.Font("Monospaced", 0, 12));
        jTextArea1.setRows(5);
        jTextArea1.setBorder(javax.swing.BorderFactory.createTitledBorder(javax.swing.BorderFactory.createTitledBorder("输出信息")));
        jTextArea1.setFocusable(false);
        jTextArea1.setName("jTextArea1"); // NOI18N
        jScrollPane1.setViewportView(jTextArea1);

        jPanel3.setFocusable(false);
        jPanel3.setName("jPanel3"); // NOI18N

        jButton4.setText("开始扫码");
        jButton4.setFocusable(false);
        jButton4.setName("jButton4"); // NOI18N
        jButton4.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton4ActionPerformed(evt);
            }
        });

        jButton5.setText("暂停/继续扫码");
        jButton5.setFocusable(false);
        jButton5.setName("jButton5"); // NOI18N
        jButton5.setRequestFocusEnabled(false);
        jButton5.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton5ActionPerformed(evt);
            }
        });

        jButton6.setText("终止扫码");
        jButton6.setFocusable(false);
        jButton6.setName("jButton6"); // NOI18N
        jButton6.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton6ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addGap(31, 31, 31)
                .addComponent(jButton4, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(53, 53, 53)
                .addComponent(jButton5, javax.swing.GroupLayout.PREFERRED_SIZE, 141, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(42, 42, 42)
                .addComponent(jButton6, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(221, Short.MAX_VALUE))
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addGap(10, 10, 10)
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jButton4, javax.swing.GroupLayout.PREFERRED_SIZE, 42, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jButton5, javax.swing.GroupLayout.PREFERRED_SIZE, 42, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jButton6, javax.swing.GroupLayout.PREFERRED_SIZE, 42, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap(12, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jScrollPane1, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 740, Short.MAX_VALUE)
            .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 304, Short.MAX_VALUE)
                .addContainerGap())
        );

        jPanel2.setFocusable(false);
        jPanel2.setName("jPanel2"); // NOI18N

        comboxTask.setFocusable(false);
        comboxTask.setName("comboxTask"); // NOI18N
        comboxTask.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                comboxTaskActionPerformed(evt);
            }
        });

        jLabel2.setFont(new java.awt.Font("Dialog", 0, 18)); // NOI18N
        jLabel2.setText("选择任务：");
        jLabel2.setFocusable(false);
        jLabel2.setName("jLabel2"); // NOI18N

        jLabel5.setFont(new java.awt.Font("Dialog", 0, 18)); // NOI18N
        jLabel5.setText("选择零箱：");
        jLabel5.setFocusable(false);
        jLabel5.setName("jLabel5"); // NOI18N

        breakCarton.setFocusable(false);
        breakCarton.setName("breakCarton"); // NOI18N

        portId.setEditable(false);
        portId.setFont(new java.awt.Font("Dialog", 0, 18)); // NOI18N
        portId.setText("56000");
        portId.setName("portId"); // NOI18N

        jLabel7.setFont(new java.awt.Font("Dialog", 0, 18)); // NOI18N
        jLabel7.setText("端口号：");
        jLabel7.setFocusable(false);
        jLabel7.setName("jLabel7"); // NOI18N

        jLabel6.setFont(new java.awt.Font("Dialog", 0, 18)); // NOI18N
        jLabel6.setText("批次：");
        jLabel6.setFocusable(false);
        jLabel6.setName("jLabel6"); // NOI18N

        batchLine.setEditable(false);
        batchLine.setFont(new java.awt.Font("Dialog", 0, 18)); // NOI18N
        batchLine.setName("batchLine"); // NOI18N

        jLabel8.setFont(new java.awt.Font("Dialog", 0, 18)); // NOI18N
        jLabel8.setText("规格：");
        jLabel8.setFocusable(false);
        jLabel8.setName("jLabel8"); // NOI18N

        standard.setEditable(false);
        standard.setFont(new java.awt.Font("Dialog", 0, 18)); // NOI18N
        standard.setName("standard"); // NOI18N

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addComponent(jLabel2)
                        .addGap(18, 18, 18)
                        .addComponent(comboxTask, javax.swing.GroupLayout.PREFERRED_SIZE, 347, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel5)
                            .addComponent(jLabel6))
                        .addGap(18, 18, 18)
                        .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(jPanel2Layout.createSequentialGroup()
                                .addComponent(breakCarton, javax.swing.GroupLayout.PREFERRED_SIZE, 80, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(41, 41, 41)
                                .addComponent(jLabel7)
                                .addGap(18, 18, 18)
                                .addComponent(portId))
                            .addGroup(jPanel2Layout.createSequentialGroup()
                                .addComponent(batchLine, javax.swing.GroupLayout.PREFERRED_SIZE, 105, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(18, 18, 18)
                                .addComponent(jLabel8)
                                .addGap(18, 18, 18)
                                .addComponent(standard, javax.swing.GroupLayout.DEFAULT_SIZE, 154, Short.MAX_VALUE)))))
                .addContainerGap(273, Short.MAX_VALUE))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap(39, Short.MAX_VALUE)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2)
                    .addComponent(comboxTask, javax.swing.GroupLayout.PREFERRED_SIZE, 30, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel5)
                    .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(breakCarton, javax.swing.GroupLayout.PREFERRED_SIZE, 28, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(portId, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jLabel7)))
                .addGap(18, 18, 18)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel6)
                    .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(batchLine, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(standard, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jLabel8)))
                .addContainerGap())
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, 0, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

private void jButton4ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton4ActionPerformed
    if (task == null) {
        MessageUtils.showMessage("请选择一个任务！");
        comboxTask.requestFocus();
    }

    int portid = 8085;
    if (!StringUtils.isNullOrEmpty(portId.getText())) {
        portid = new Integer(portId.getText());
    }
    try {
        localSocketServer = new LocalSocketServer(portid, new Integer(task.getStandard()), this);
    } catch (IOException ex) {
        VoiceUtils.play("系统异常.wav");
        java.util.logging.Logger.getLogger(SocketScanManage.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
    }
    Thread t = new Thread(localSocketServer);
    t.start();
    VoiceUtils.play("任务启动.wav");
    jButton4.setEnabled(false);
    comboxTask.setEnabled(false);
}//GEN-LAST:event_jButton4ActionPerformed

private void jButton5ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton5ActionPerformed

    if (localSocketServer.getSuspend()) {
        localSocketServer.awake();
    } else {
        localSocketServer.suspend();
    }
}//GEN-LAST:event_jButton5ActionPerformed

private void jButton6ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton6ActionPerformed
    localSocketServer.stopServer();
    jButton4.setEnabled(true);
    VoiceUtils.play("任务结束.wav");
}//GEN-LAST:event_jButton6ActionPerformed

private void comboxTaskActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_comboxTaskActionPerformed
    String id = comboxTask.getSelectValue();
    task = DataBaseUtil.findTaskByid(new Integer(id));
    batchLine.setText(task.getBatchnumber());
    standard.setText(task.getStandard());
}//GEN-LAST:event_comboxTaskActionPerformed

    public void appendTextFiledText(final String text) {

        // 利用EnventQueue类来更新Swing控件
        EventQueue.invokeLater(new Runnable() {

            @Override
            public void run() {
                jTextArea1.append(text);
            }
        });
    }

    public void bindBoxAndProd(Map<String, Object> codes) {
        String boxCode = "";
        logger.info("开始绑定箱码");
        appendTextFiledText("\n" + "---------------------开始绑定箱码--------------------");
        List<BoxConnProd> l = new ArrayList<BoxConnProd>(codes.size());
        for (Entry<String, Object> entry : codes.entrySet()) {
            if (((Integer) entry.getValue()) == 2) {
                boxCode = entry.getKey();
                continue;
            }
            BoxConnProd boxConnProd = new BoxConnProd();
            boxConnProd.setBatch(task.getId().toString());
            boxConnProd.setTaskid(new Integer(comboxTask.getSelectValue()));
            boxConnProd.setBoxcode(boxCode.replaceAll("输入的二维码为:", "").replaceAll("输入的箱码为:", ""));
            boxConnProd.setProdcode(entry.getKey());
            boxConnProd.setSize(codes.size());
            l.add(boxConnProd);
        }
        for (int i = 0; i < l.size(); i++) {
            BoxConnProd p = l.get(i);
            appendTextFiledText("\n" + "开始绑定第" + (i + 1) + "个二维码-------------->");
            p.setBoxcode(boxCode);
            DataBaseUtil.insertBoxAndProdCode(p);
            appendTextFiledText("\n" + "绑定第" + (i + 1) + "个二维码结束-------------->");
        }
        appendTextFiledText("\n" + "---------------------绑定箱码结束--------------------");
        appendTextFiledText("\n" + "-------------------本次任务成功！--------------------");
    }

    public void showBeginMes() {
        JOptionPane.showMessageDialog(this, "开始扫码！");
    }

    public void setEnableds(boolean bol) {
        jButton4.setEnabled(bol);
        comboxTask.setEnabled(bol);                 
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTextField batchLine;
    private QRCode.compnents.MyCombobox breakCarton;
    private QRCode.compnents.MyCombobox comboxTask;
    private javax.swing.JButton jButton4;
    private javax.swing.JButton jButton5;
    private javax.swing.JButton jButton6;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTextArea jTextArea1;
    private javax.swing.JTextField portId;
    private javax.swing.JTextField standard;
    // End of variables declaration//GEN-END:variables
}
